<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noah's Toolbox - Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            padding: 40px;
        }

        .app-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        /* Main App Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .username {
            color: #667eea;
            font-weight: 600;
        }

        .logout-btn {
            width: auto;
            padding: 8px 20px;
            background: #dc3545;
            font-size: 14px;
        }

        .admin-btn {
            width: auto;
            padding: 8px 20px;
            background: #28a745;
            font-size: 14px;
            margin-right: 10px;
        }

        .work-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .work-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .work-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .controls button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .start-btn { background: #28a745; }
        .stop-btn { background: #dc3545; }
        .reset-btn { background: #6c757d; }

        .lists-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .list-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .list-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .list-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .list-input-group input {
            flex: 1;
        }

        .list-input-group button {
            width: auto;
            padding: 10px 20px;
        }

        .list-items {
            max-height: 200px;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .list-item button {
            width: auto;
            padding: 4px 12px;
            background: #dc3545;
            font-size: 12px;
        }

        .export-section {
            text-align: center;
        }

        .export-section button {
            width: auto;
            padding: 12px 40px;
        }

        /* Admin Panel Styles */
        .admin-panel {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .user-list {
            margin-top: 20px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .user-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-item-actions {
            display: flex;
            gap: 10px;
        }

        .user-item-actions button {
            width: auto;
            padding: 6px 15px;
            font-size: 12px;
        }

        .delete-btn {
            background: #dc3545;
        }

        .change-pass-btn {
            background: #ffc107;
        }

        .admin-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .work-grid {
                grid-template-columns: 1fr;
            }
            .lists-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <h1>Noah's Toolbox</h1>
        <p class="subtitle">Sign in to continue</p>
        
        <div id="loginError" class="error hidden"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Remember me</label>
            </div>
            
            <button type="submit">Sign In</button>
        </form>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="app-container hidden">
        <div class="header">
            <h1>Noah's Toolbox</h1>
            <div class="user-info">
                <span class="username" id="currentUser"></span>
                <button id="adminPanelBtn" class="admin-btn hidden">Admin Panel</button>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
        </div>

        <div id="mainApp">
            <div class="work-grid">
                <div class="work-section">
                    <h3>Automations</h3>
                    <div class="timer" id="timer1">00:00:00</div>
                    <p>Today: <span id="total1">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(1)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(1)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(1)">Reset</button>
                    </div>
                </div>

                <div class="work-section">
                    <h3>Email/Text</h3>
                    <div class="timer" id="timer2">00:00:00</div>
                    <p>Today: <span id="total2">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(2)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(2)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(2)">Reset</button>
                    </div>
                </div>

                <div class="work-section">
                    <h3>Calling</h3>
                    <div class="timer" id="timer3">00:00:00</div>
                    <p>Today: <span id="total3">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(3)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(3)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(3)">Reset</button>
                    </div>
                </div>

                <div class="work-section">
                    <h3>Texting</h3>
                    <div class="timer" id="timer4">00:00:00</div>
                    <p>Today: <span id="total4">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(4)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(4)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(4)">Reset</button>
                    </div>
                </div>

                <div class="work-section">
                    <h3>Quotes</h3>
                    <div class="timer" id="timer5">00:00:00</div>
                    <p>Today: <span id="total5">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(5)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(5)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(5)">Reset</button>
                    </div>
                </div>

                <div class="work-section">
                    <h3>Other</h3>
                    <div class="timer" id="timer6">00:00:00</div>
                    <p>Today: <span id="total6">00:00:00</span></p>
                    <div class="controls">
                        <button class="start-btn" onclick="startTimer(6)">Start</button>
                        <button class="stop-btn" onclick="stopTimer(6)">Stop</button>
                        <button class="reset-btn" onclick="resetTimer(6)">Reset</button>
                    </div>
                </div>
            </div>

            <div class="lists-grid">
                <div class="list-section">
                    <h3>Interviews Done</h3>
                    <div class="list-input-group">
                        <input type="text" id="list1Input" placeholder="Add item">
                        <button onclick="addToList(1)">Add</button>
                    </div>
                    <div class="list-items" id="list1"></div>
                </div>

                <div class="list-section">
                    <h3>Loom Presentations</h3>
                    <div class="list-input-group">
                        <input type="text" id="list2Input" placeholder="Add item">
                        <button onclick="addToList(2)">Add</button>
                    </div>
                    <div class="list-items" id="list2"></div>
                </div>

                <div class="list-section">
                    <h3>New Business Submission</h3>
                    <div class="list-input-group">
                        <input type="text" id="list3Input" placeholder="Add item">
                        <button onclick="addToList(3)">Add</button>
                    </div>
                    <div class="list-items" id="list3"></div>
                </div>

                <div class="list-section">
                    <h3>New Business Premium</h3>
                    <div class="list-input-group">
                        <input type="text" id="list4Input" placeholder="Premium amount ($)">
                        <button onclick="addToList(4)">Add</button>
                    </div>
                    <div class="list-items" id="list4"></div>
                </div>

                <div class="list-section">
                    <h3>Requote Submission</h3>
                    <div class="list-input-group">
                        <input type="text" id="list5Input" placeholder="Add item">
                        <button onclick="addToList(5)">Add</button>
                    </div>
                    <div class="list-items" id="list5"></div>
                </div>

                <div class="list-section">
                    <h3>Requote Premium</h3>
                    <div class="list-input-group">
                        <input type="text" id="list6Input" placeholder="Premium amount ($)">
                        <button onclick="addToList(6)">Add</button>
                    </div>
                    <div class="list-items" id="list6"></div>
                </div>
            </div>

            <div class="export-section">
                <button onclick="exportToCSV()">Export to CSV</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel hidden">
            <h2>User Management</h2>
            
            <div id="adminError" class="error hidden"></div>
            <div id="adminSuccess" class="success hidden"></div>

            <div class="form-group">
                <label for="newUsername">New Username</label>
                <input type="text" id="newUsername">
            </div>

            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="isAdmin">
                <label for="isAdmin">Admin user</label>
            </div>

            <button onclick="createUser()">Create User</button>

            <div class="user-list" id="userList"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ekcpjqzgmnmtufdjqmdk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrY3BqcXpnbW5tdHVmZGpxbWRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ3NDg4MjMsImV4cCI6MjA1MDMyNDgyM30.2XMcEJVHmQzuuRIv8NfgQ3DWZjmBqNUtxz2Cj6vJCEM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentUser = null;
        let timers = {
            1: { active: false, seconds: 0, interval: null, totalSeconds: 0 },
            2: { active: false, seconds: 0, interval: null, totalSeconds: 0 },
            3: { active: false, seconds: 0, interval: null, totalSeconds: 0 },
            4: { active: false, seconds: 0, interval: null, totalSeconds: 0 },
            5: { active: false, seconds: 0, interval: null, totalSeconds: 0 },
            6: { active: false, seconds: 0, interval: null, totalSeconds: 0 }
        };
        let lists = {
            1: [], 2: [], 3: [], 4: [], 5: [], 6: []
        };

        // Password Hashing
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        // Check for remembered user
        window.addEventListener('load', () => {
            const rememberedUser = localStorage.getItem('rememberedUser');
            const rememberedHash = localStorage.getItem('rememberedHash');
            
            if (rememberedUser && rememberedHash) {
                autoLogin(rememberedUser, rememberedHash);
            }
        });

        // Auto login
        async function autoLogin(username, passwordHash) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password_hash', passwordHash)
                    .single();

                if (data && !error) {
                    currentUser = data;
                    showApp();
                    await loadData();
                }
            } catch (err) {
                console.log('Auto-login failed');
            }
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const passwordHash = hashPassword(password);

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password_hash', passwordHash)
                    .single();

                if (error || !data) {
                    showError('Invalid username or password');
                    return;
                }

                currentUser = data;

                if (rememberMe) {
                    localStorage.setItem('rememberedUser', username);
                    localStorage.setItem('rememberedHash', passwordHash);
                }

                showApp();
                await loadData();
            } catch (err) {
                showError('Login failed. Please try again.');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser.username;
            
            if (currentUser.is_admin) {
                document.getElementById('adminPanelBtn').classList.remove('hidden');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('rememberedUser');
            localStorage.removeItem('rememberedHash');
            currentUser = null;
            
            // Stop all timers
            for (let i = 1; i <= 6; i++) {
                if (timers[i].active) stopTimer(i);
            }
            
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        });

        // Admin Panel Toggle
        document.getElementById('adminPanelBtn').addEventListener('click', async () => {
            const panel = document.getElementById('adminPanel');
            const mainApp = document.getElementById('mainApp');
            
            if (panel.classList.contains('hidden')) {
                mainApp.classList.add('hidden');
                panel.classList.remove('hidden');
                await loadUsers();
            } else {
                panel.classList.add('hidden');
                mainApp.classList.remove('hidden');
            }
        });

        // Create User
        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const isAdmin = document.getElementById('isAdmin').checked;

            if (!username || !password) {
                showAdminError('Username and password are required');
                return;
            }

            if (password.length < 6) {
                showAdminError('Password must be at least 6 characters');
                return;
            }

            const passwordHash = hashPassword(password);

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        username: username,
                        password_hash: passwordHash,
                        is_admin: isAdmin
                    }]);

                if (error) {
                    if (error.code === '23505') {
                        showAdminError('Username already exists');
                    } else {
                        showAdminError('Failed to create user');
                    }
                    return;
                }

                showAdminSuccess('User created successfully');
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('isAdmin').checked = false;
                await loadUsers();
            } catch (err) {
                showAdminError('Failed to create user');
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('username');

                if (error) throw error;

                const userListDiv = document.getElementById('userList');
                userListDiv.innerHTML = '';

                data.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.innerHTML = `
                        <div class="user-item-info">
                            <strong>${user.username}</strong>
                            ${user.is_admin ? '<span class="admin-badge">ADMIN</span>' : ''}
                        </div>
                        <div class="user-item-actions">
                            <button class="change-pass-btn" onclick="changePassword('${user.username}')">Change Password</button>
                            ${user.username !== currentUser.username ? `<button class="delete-btn" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
                        </div>
                    `;
                    userListDiv.appendChild(userDiv);
                });
            } catch (err) {
                showAdminError('Failed to load users');
            }
        }

        // Change Password
        async function changePassword(username) {
            const newPassword = prompt(`Enter new password for ${username}:`);
            if (!newPassword) return;

            if (newPassword.length < 6) {
                showAdminError('Password must be at least 6 characters');
                return;
            }

            const passwordHash = hashPassword(newPassword);

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ password_hash: passwordHash })
                    .eq('username', username);

                if (error) throw error;

                showAdminSuccess('Password updated successfully');
            } catch (err) {
                showAdminError('Failed to update password');
            }
        }

        // Delete User
        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This will also delete all their data.`)) {
                return;
            }

            try {
                // Delete user's work data first
                await supabase
                    .from('work_data')
                    .delete()
                    .eq('user_id', username);

                // Delete user
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('username', username);

                if (error) throw error;

                showAdminSuccess('User deleted successfully');
                await loadUsers();
            } catch (err) {
                showAdminError('Failed to delete user');
            }
        }

        function showAdminError(message) {
            const errorDiv = document.getElementById('adminError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function showAdminSuccess(message) {
            const successDiv = document.getElementById('adminSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        // Timer Functions
        function startTimer(num) {
            if (timers[num].active) return;
            
            timers[num].active = true;
            timers[num].interval = setInterval(() => {
                timers[num].seconds++;
                timers[num].totalSeconds++;
                updateDisplay(num);
                saveData();
            }, 1000);
        }

        function stopTimer(num) {
            if (!timers[num].active) return;
            
            timers[num].active = false;
            clearInterval(timers[num].interval);
            saveData();
        }

        function resetTimer(num) {
            stopTimer(num);
            timers[num].seconds = 0;
            updateDisplay(num);
            saveData();
        }

        function updateDisplay(num) {
            document.getElementById(`timer${num}`).textContent = formatTime(timers[num].seconds);
            document.getElementById(`total${num}`).textContent = formatTime(timers[num].totalSeconds);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // List Functions
        function addToList(num) {
            const input = document.getElementById(`list${num}Input`);
            const value = input.value.trim();
            
            if (!value) return;
            
            lists[num].push(value);
            input.value = '';
            renderList(num);
            saveData();
        }

        function removeFromList(num, index) {
            lists[num].splice(index, 1);
            renderList(num);
            saveData();
        }

        function renderList(num) {
            const container = document.getElementById(`list${num}`);
            container.innerHTML = '';
            
            lists[num].forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${item}</span>
                    <button onclick="removeFromList(${num}, ${index})">Delete</button>
                `;
                container.appendChild(div);
            });
        }

        // Save Data to Supabase
        async function saveData() {
            if (!currentUser) return;

            const today = new Date().toISOString().split('T')[0];
            
            const dataToSave = {
                user_id: currentUser.username,
                date: today,
                timer1
