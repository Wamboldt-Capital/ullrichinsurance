<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base - Noah's Toolbox</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            color: #333;
        }
        
        .loading-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0a84ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-screen {
            display: none;
            text-align: center;
            padding: 40px;
            max-width: 500px;
            margin: 100px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .error-screen h2 { color: #ff3b30; margin-bottom: 20px; }
        .error-screen p { color: #666; margin-bottom: 30px; line-height: 1.6; }
        .error-screen a {
            display: inline-block;
            padding: 12px 24px;
            background: #0a84ff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
        }
        .error-screen a:hover { background: #0077ed; }
        
        .container {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #0a84ff;
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            background: #0a84ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover { background: #0077ed; }
        .btn.secondary { background: #6c757d; }
        .btn.secondary:hover { background: #5a6268; }
        .btn.success { background: #10b981; }
        .btn.success:hover { background: #059669; }
        .btn.danger { background: #ff3b30; }
        .btn.danger:hover { background: #d32f2f; }
        
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #0a84ff;
        }
        
        .articles-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .article-item {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .article-item:hover {
            background: #f9fafb;
        }
        
        .article-item:last-child {
            border-bottom: none;
        }
        
        .article-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .article-date {
            font-size: 14px;
            color: #666;
        }
        
        .article-actions {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            color: #666;
        }
        
        .icon-btn:hover { color: #0a84ff; }
        .icon-btn.delete:hover { color: #ff3b30; }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        /* Article View */
        .article-view {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 40px;
        }
        
        .article-view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .article-view-title {
            font-size: 32px;
            font-weight: 700;
            color: #0a84ff;
            flex: 1;
        }
        
        .article-view-actions {
            display: flex;
            gap: 10px;
        }
        
        .article-view-content {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #0a84ff;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover { color: #333; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 400px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0a84ff;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 2000;
            display: none;
        }
        
        .status.show { display: block; }
        .status.error { background: #ef4444; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <p>Loading Knowledge Base...</p>
    </div>

    <div class="error-screen" id="errorScreen">
        <h2>‚ö†Ô∏è Access Denied</h2>
        <p id="errorMessage">Your session is invalid or has expired.</p>
        <p>Please log in to access the knowledge base.</p>
        <a href="index.html">Go to Login Page</a>
    </div>

    <div class="container" id="mainContent">
        <div class="status" id="status"></div>
        
        <div class="header">
            <div>
                <h1>üìö Knowledge Base</h1>
                <p style="color: #666; margin-top: 5px;">User: <span id="currentUser"></span></p>
            </div>
            <div class="header-buttons">
                <a href="toolbox.html" class="btn secondary">Back to Toolbox</a>
                <button class="btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div id="listView">
            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search articles...">
                <button class="btn success" id="newArticleBtn">+ New Article</button>
            </div>

            <div class="articles-list" id="articlesList"></div>
        </div>

        <div class="article-view" id="articleView">
            <div class="article-view-header">
                <h1 class="article-view-title" id="viewArticleTitle"></h1>
                <div class="article-view-actions">
                    <button class="btn secondary" id="backToListBtn">‚Üê Back</button>
                    <button class="btn" id="editArticleBtn">Edit</button>
                    <button class="btn danger" id="deleteArticleBtn">Delete</button>
                </div>
            </div>
            <div class="article-view-content" id="viewArticleContent"></div>
        </div>
    </div>

    <!-- Article Modal -->
    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="articleModalTitle">New Article</h2>
                <button class="close-modal" id="closeArticleModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="articleTitleInput">Article Title</label>
                <input type="text" id="articleTitleInput" placeholder="Enter article title">
            </div>
            <div class="form-group">
                <label for="articleContentInput">Content</label>
                <textarea id="articleContentInput" placeholder="Enter article content..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn secondary" id="cancelArticleBtn">Cancel</button>
                <button class="btn success" id="saveArticleBtn">Save Article</button>
            </div>
        </div>
    </div>

    <script>
        (async () => {
            const SUPABASE_URL = 'https://nggpymtnuuxfvgcuzemd.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nZ3B5bXRudXV4ZnZnY3V6ZW1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzMxMDksImV4cCI6MjA3NjIwOTEwOX0.6ihxow3cJH5ONA1UV1UTM4xKMASWLLrN424FZ6IORAI';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Session validation
            async function validateSession(sessionToken) {
                if (!sessionToken) return null;
                const result = await supabase
                    .from('sessions')
                    .select('*, users(*)')
                    .eq('session_token', sessionToken)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                return result.error || !result.data ? null : result.data.users;
            }

            async function deleteSession(sessionToken) {
                if (!sessionToken) return;
                await supabase.from('sessions').delete().eq('session_token', sessionToken);
                localStorage.removeItem('sessionToken');
                sessionStorage.removeItem('sessionToken');
            }

            function showError(message) {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('errorScreen').style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
            }

            const sessionToken = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            if (!sessionToken) {
                showError('No active session found. Please log in.');
                return;
            }

            const user = await validateSession(sessionToken);
            if (!user) {
                showError('Your session is invalid or has expired. Please log in again.');
                localStorage.removeItem('sessionToken');
                sessionStorage.removeItem('sessionToken');
                return;
            }

            // Show main content
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('currentUser').textContent = user.display_name || user.username;

            // Logout handler
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    await deleteSession(sessionToken);
                    window.location.href = 'https://ireallylovetexas.github.io/ullrichinsurance/';
                }
            });

            // Knowledge base logic
            let articles = [];
            let currentArticleId = null;

            function showStatus(message, type = 'success') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status show ${type === 'error' ? 'error' : ''}`;
                setTimeout(() => statusEl.className = 'status', 3000);
            }

            async function loadArticles() {
                const { data, error } = await supabase
                    .from('kb_articles')
                    .select('*')
                    .order('title');

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading articles:', error);
                    showStatus('Error loading articles', 'error');
                    return;
                }

                articles = data || [];
                renderArticles();
            }

            function renderArticles(searchTerm = '') {
                const container = document.getElementById('articlesList');
                container.innerHTML = '';

                let filteredArticles = articles;
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    filteredArticles = articles.filter(article => 
                        article.title.toLowerCase().includes(search) || 
                        article.content.toLowerCase().includes(search)
                    );
                }

                if (filteredArticles.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>${searchTerm ? 'No articles found' : 'No articles yet'}</h3>
                            <p>${searchTerm ? 'Try a different search term' : 'Click "New Article" to create your first article'}</p>
                        </div>
                    `;
                    return;
                }

                filteredArticles.forEach(article => {
                    const articleEl = document.createElement('div');
                    articleEl.className = 'article-item';
                    
                    const date = new Date(article.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    articleEl.innerHTML = `
                        <div>
                            <div class="article-title">${article.title}</div>
                            <div class="article-date">Created: ${date}</div>
                        </div>
                    `;
                    
                    articleEl.addEventListener('click', () => showArticle(article.id));
                    container.appendChild(articleEl);
                });
            }

            function showArticle(articleId) {
                const article = articles.find(a => a.id === articleId);
                if (!article) return;

                currentArticleId = articleId;
                document.getElementById('viewArticleTitle').textContent = article.title;
                document.getElementById('viewArticleContent').textContent = article.content;

                document.getElementById('listView').style.display = 'none';
                document.getElementById('articleView').style.display = 'block';
            }

            function showList() {
                document.getElementById('listView').style.display = 'block';
                document.getElementById('articleView').style.display = 'none';
                currentArticleId = null;
            }

            function openArticleModal(article = null) {
                currentArticleId = article ? article.id : null;
                document.getElementById('articleModalTitle').textContent = article ? 'Edit Article' : 'New Article';
                document.getElementById('articleTitleInput').value = article ? article.title : '';
                document.getElementById('articleContentInput').value = article ? article.content : '';
                document.getElementById('articleModal').style.display = 'block';
            }

            function closeArticleModal() {
                document.getElementById('articleModal').style.display = 'none';
                currentArticleId = null;
            }

            async function saveArticle() {
                const title = document.getElementById('articleTitleInput').value.trim();
                const content = document.getElementById('articleContentInput').value.trim();

                if (!title || !content) {
                    showStatus('Please enter both title and content', 'error');
                    return;
                }

                if (currentArticleId) {
                    // Update existing article
                    const { error } = await supabase
                        .from('kb_articles')
                        .update({ title, content, updated_at: new Date().toISOString() })
                        .eq('id', currentArticleId);

                    if (error) {
                        showStatus('Error updating article', 'error');
                        return;
                    }

                    const article = articles.find(a => a.id === currentArticleId);
                    article.title = title;
                    article.content = content;
                    
                    showStatus('Article updated!');
                } else {
                    // Create new article
                    const { data, error } = await supabase
                        .from('kb_articles')
                        .insert([{ title, content }])
                        .select()
                        .single();

                    if (error) {
                        showStatus('Error creating article', 'error');
                        return;
                    }

                    articles.push(data);
                    articles.sort((a, b) => a.title.localeCompare(b.title));
                    showStatus('Article created!');
                }

                closeArticleModal();
                renderArticles();
                showList();
            }

            async function deleteArticle() {
                if (!confirm('Delete this article permanently?')) return;

                const { error } = await supabase
                    .from('kb_articles')
                    .delete()
                    .eq('id', currentArticleId);

                if (error) {
                    showStatus('Error deleting article', 'error');
                    return;
                }

                articles = articles.filter(a => a.id !== currentArticleId);
                showStatus('Article deleted');
                showList();
                renderArticles();
            }

            // Event listeners
            document.getElementById('newArticleBtn').addEventListener('click', () => openArticleModal());
            document.getElementById('backToListBtn').addEventListener('click', showList);
            document.getElementById('editArticleBtn').addEventListener('click', () => {
                const article = articles.find(a => a.id === currentArticleId);
                openArticleModal(article);
            });
            document.getElementById('deleteArticleBtn').addEventListener('click', deleteArticle);

            document.getElementById('closeArticleModal').addEventListener('click', closeArticleModal);
            document.getElementById('cancelArticleBtn').addEventListener('click', closeArticleModal);
            document.getElementById('saveArticleBtn').addEventListener('click', saveArticle);

            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderArticles(e.target.value);
            });

            // Close modal on outside click
            window.addEventListener('click', (e) => {
                if (e.target.id === 'articleModal') closeArticleModal();
            });

            // Load initial data
            await loadArticles();
        })();
    </script>
</body>
</html>
